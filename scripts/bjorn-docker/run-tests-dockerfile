FROM otp-src

WORKDIR /daily_build

RUN mkdir otp
ENV install_dir=/daily_build/otp

WORKDIR otp_src
ENV MAKEFLAGS=-j8
RUN ./otp_build configure
ENV ERL_TOP=/daily_build/otp_src
RUN ./otp_build boot -a
RUN ./otp_build release -a $install_dir

WORKDIR $install_dir
RUN ./Install -minimal $install_dir

WORKDIR /daily_build
ENV PATH=$install_dir/bin:$PATH

COPY otp-run-tests /daily_build/otp-run-tests

WORKDIR /daily_build/test/test_server

# Install and replace the temporary hostname with 'docker'
# in the variables file.
RUN /daily_build/otp/bin/erl -noinput -s ts install -s init stop && \
  perl -pi -e "/^[{]platform/ && s/$(hostname)/docker/g" variables

CMD /daily_build/otp-run-tests
